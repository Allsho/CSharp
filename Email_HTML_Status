using System;
using System.Data;
using System.Text;
using Microsoft.SqlServer.Dts.Runtime;
using ADODB;  // Ensure the ADODB namespace is referenced

public void Main()
{
    // Retrieve the Recordset
    Recordset recordset = (Recordset)Dts.Variables["User::TableInfoRecordset"].Value;

    // Check if the Recordset is null
    if (recordset == null)
    {
        Dts.Events.FireError(0, "Script Task", "The recordset is null. Ensure the Recordset Destination is correctly populated.", string.Empty, 0);
        Dts.TaskResult = (int)ScriptResults.Failure;
        return;
    }

    // Initialize a StringBuilder to construct the email body
    StringBuilder emailBody = new StringBuilder();

    // Add column headers
    for (int i = 0; i < recordset.Fields.Count; i++)
    {
        emailBody.Append(recordset.Fields[i].Name + "\t");
    }
    emailBody.AppendLine();

    // Add each row from the recordset
    recordset.MoveFirst();
    while (!recordset.EOF)
    {
        for (int i = 0; i < recordset.Fields.Count; i++)
        {
            emailBody.Append(recordset.Fields[i].Value.ToString() + "\t");
        }
        emailBody.AppendLine();
        recordset.MoveNext();
    }

    // Store the email content in the EmailBody variable
    Dts.Variables["User::EmailBody"].Value = emailBody.ToString();

    Dts.TaskResult = (int)ScriptResults.Success;
}
