using System;
using System.Data;
using System.Text;
using Microsoft.SqlServer.Dts.Runtime;
using System.Collections;

public void Main()
{
    // Retrieve the recordset variable
    Object obj = Dts.Variables["User::TableInfoRecordset"].Value;
    DataTable dt = new DataTable();
    
    // Load data from the recordset into a DataTable for easy processing
    using (OleDbDataAdapter adapter = new OleDbDataAdapter())
    {
        adapter.Fill(dt, obj as IEnumerable);
    }

    // Use StringBuilder to build the email body dynamically
    StringBuilder emailBody = new StringBuilder();
    
    // Add column headers
    foreach (DataColumn column in dt.Columns)
    {
        emailBody.Append(column.ColumnName + "\t");
    }
    emailBody.AppendLine();

    // Add rows of data
    foreach (DataRow row in dt.Rows)
    {
        foreach (var item in row.ItemArray)
        {
            emailBody.Append(item.ToString() + "\t");
        }
        emailBody.AppendLine();
    }

    // Store the email content in the EmailBody variable
    Dts.Variables["User::EmailBody"].Value = emailBody.ToString();

    Dts.TaskResult = (int)ScriptResults.Success;
}
