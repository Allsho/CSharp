CREATE TABLE MoveIt.EmailAddresses
(
    PayerName NVARCHAR(100),
    Sender NVARCHAR(100),
    Recipient NVARCHAR(500),
    CC NVARCHAR(500) NULL
);

private (string Sender, string Recipient, string CC) GetEmailAddresses(string payerName)
{
    var connStr = _vars["User::CM_OLEDB_ClaimsStage"].Value.ToString();
    using (var conn = new SqlConnection(connStr))
    {
        conn.Open();
        string query = @"SELECT Sender, Recipient, CC 
                         FROM MoveIt.EmailAddresses 
                         WHERE PayerName = @PayerName";
        using (var cmd = new SqlCommand(query, conn))
        {
            cmd.Parameters.AddWithValue("@PayerName", payerName);
            using (var reader = cmd.ExecuteReader())
            {
                if (reader.Read())
                {
                    return (
                        Sender: reader["Sender"].ToString(),
                        Recipient: reader["Recipient"].ToString(),
                        CC: reader["CC"]?.ToString() ?? string.Empty
                    );
                }
            }
        }
    }
    return (Sender: string.Empty, Recipient: string.Empty, CC: string.Empty);
}

var addresses = GetEmailAddresses(payerName);

using (var message = new MailMessage(addresses.Sender, addresses.Recipient))
{
    message.Subject = subject;
    message.Body = htmlBody;
    message.IsBodyHtml = true;
    if (!string.IsNullOrWhiteSpace(addresses.CC))
        message.CC.Add(addresses.CC);

    using (var client = new SmtpClient())
    {
        client.Send(message);
    }
}
