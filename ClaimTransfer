// Main.cs
using System;
using Microsoft.SqlServer.Dts.Runtime;

public class ScriptMain
{
    public void Main()
    {
        ConnectionManager smtpConnection = Dts.Connections["CM_SMTP_EXHUB"];
        string smtpServer = smtpConnection.Properties["SmtpServer"].GetValue(smtpConnection).ToString();

        try
        {
            // Load configuration from SSIS variables
            var config = Config.LoadFromVariables(Dts.Variables);

            // Process files
            var processor = new FileProcessor(config, new Logger(Dts.Variables), Dts.Variables, null);
            processor.Execute();

            // Generate professional log summary directly from database
            var logSummary = new GetLogSummary(Dts.Variables);
            string htmlBody = logSummary.GenerateHtml(config.MappingID);

            // Send summary email
            var emailer = new Emailer(Dts.Variables);
            emailer.SendEmail(smtpServer, "File Processing Summary", htmlBody, config.PayerName);

            Dts.TaskResult = (int)ScriptResults.Success;
            Console.WriteLine("Main execution completed successfully.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error in Main(): {ex.Message}");
            new Logger(Dts.Variables).LogError("Main", ex.Message);
            Dts.TaskResult = (int)ScriptResults.Failure;
        }
    }
}
