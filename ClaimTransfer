public void Main()
{
    try
    {
        // ðŸ”¹ Get SMTP connection from SSIS
        ConnectionManager smtpConnection = Dts.Connections["CM_SMTP_EXHUB"];
        string smtpServer = smtpConnection.Properties["SmtpServer"].GetValue(smtpConnection).ToString();

        // ðŸ”¹ Load summary from DB (based on latest ProcessedAt)
        var summary = new EmailSummary();
        string connStr = Dts.Variables["User::CM_OLEDB_ClaimsStage"].Value.ToString();
        summary.LoadFromDatabase(connStr);

        // ðŸ”¹ Generate HTML body
        string htmlBody = summary.GenerateHtml();

        // If no files were processed, skip sending email
        if (string.IsNullOrWhiteSpace(htmlBody) || htmlBody.Contains("No files processed"))
        {
            Console.WriteLine("No files processed. Email not sent.");
            Dts.TaskResult = (int)ScriptResults.Success;
            return;
        }

        // ðŸ”¹ Send email (payerName is optional for lookup, can default to 'All')
        var emailer = new Emailer(Dts.Variables);
        emailer.SendEmail(smtpServer, "File Processing Summary", htmlBody, "All");

        Dts.TaskResult = (int)ScriptResults.Success;
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Error in Email Script Task: {ex.Message}");
        new Logger(Dts.Variables).LogError("EmailScriptTask", ex.Message);
        Dts.TaskResult = (int)ScriptResults.Failure;
    }
}
